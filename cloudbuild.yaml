# Cloud Buildé…ç½® - AI Trading Systemè‡ªå‹•éƒ¨ç½²
# ç•¶pushåˆ°GitHubæ™‚ï¼Œè‡ªå‹•æ§‹å»ºä¸¦éƒ¨ç½²åˆ°Cloud Run

substitutions:
  _REGION: asia-northeast1
  _SERVICE: auto-trade-ai
  _REPO: cloud-run
  _MEMORY: 2Gi
  _CPU: 1

options:
  logging: CLOUD_LOGGING_ONLY
  substitution_option: ALLOW_LOOSE

steps:
  # æ­¥é©Ÿ1: æª¢æŸ¥é …ç›®çµæ§‹
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
    - '-c'
    - |
      echo "ğŸš€ AI Trading System - é–‹å§‹è‡ªå‹•éƒ¨ç½²"
      echo "ğŸ“‚ æª¢æŸ¥é …ç›®çµæ§‹..."
      ls -la
      echo "ğŸ“‹ æª¢æŸ¥é—œéµæ–‡ä»¶..."
      ls -la src/api/
      ls -la config/
      echo "ğŸ“„ æª¢æŸ¥ä¾è³´æ–‡ä»¶..."
      cat requirements-core.txt | head -10

  # æ­¥é©Ÿ2: æ§‹å»ºDockeré¡åƒ
  - name: 'gcr.io/cloud-builders/docker'
    args:
    - 'build'
    - '-t'
    - '$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPO/$_SERVICE:$SHORT_SHA'
    - '-t'
    - '$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPO/$_SERVICE:latest'
    - '-f'
    - 'Dockerfile.cloudrun'
    - '.'

  # æ­¥é©Ÿ3: æ¨é€é¡åƒåˆ°Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: 
    - 'push'
    - '$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPO/$_SERVICE:$SHORT_SHA'

  - name: 'gcr.io/cloud-builders/docker'
    args:
    - 'push' 
    - '$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPO/$_SERVICE:latest'

  # æ­¥é©Ÿ4: éƒ¨ç½²åˆ°Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'gcloud'
    args:
    - 'run'
    - 'deploy'
    - '$_SERVICE'
    - '--image=$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPO/$_SERVICE:$SHORT_SHA'
    - '--region=$_REGION'
    - '--platform=managed'
    - '--allow-unauthenticated'
    - '--memory=$_MEMORY'
    - '--cpu=$_CPU'
    - '--timeout=900'
    - '--max-instances=10'
    - '--concurrency=80'
    - '--set-env-vars=ENVIRONMENT=production,DEBUG=false,DATABASE_URL=sqlite:///tmp/trading.db,JWT_SECRET_KEY=pI3tqLLwskk4HQ4fSlLOo32VuRsllB3Z_1eMzgrqjmY,GOOGLE_CLIENT_ID=610357573971-t2r6c0b3i8fq8kng1j8e5s4l6jiqiggf.apps.googleusercontent.com'
    - '--port=8000'

  # æ­¥é©Ÿ5: ç²å–éƒ¨ç½²çµæœ
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
    - '-c'
    - |
      echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼ç²å–æœå‹™ä¿¡æ¯..."
      SERVICE_URL=$(gcloud run services describe $_SERVICE --region=$_REGION --format='value(status.url)')
      echo "ğŸŒ AI Trading System URL: $SERVICE_URL"
      echo "ğŸ“š APIæ–‡æª”: $SERVICE_URL/docs"
      echo "ğŸ’š å¥åº·æª¢æŸ¥: $SERVICE_URL/health"
      echo "ğŸ« å…Œæ›ç¢¼ç³»çµ±: $SERVICE_URL/api/redemption"
      echo "ğŸ“ˆ è‚¡ç¥¨åˆ†æç¤ºä¾‹: $SERVICE_URL/analyze/AAPL"
      echo ""
      echo "âœ… è‡ªå‹•éƒ¨ç½²æµç¨‹å®Œæˆï¼"
      
      # æ¸¬è©¦å¥åº·æª¢æŸ¥
      echo "ğŸ§ª æ¸¬è©¦éƒ¨ç½²çµæœ..."
      curl -s -f "$SERVICE_URL/health" && echo "âœ… æœå‹™å¥åº·æª¢æŸ¥é€šé" || echo "âš ï¸ æœå‹™å¯èƒ½é‚„åœ¨å•Ÿå‹•ä¸­"

# æ¨é€é¡åƒåˆ°è¨»å†Šè¡¨
images:
- '$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPO/$_SERVICE:$SHORT_SHA'
- '$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPO/$_SERVICE:latest'

# æ§‹å»ºè¶…æ™‚è¨­ç½®
timeout: '1200s'