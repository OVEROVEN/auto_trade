#!/bin/bash

# AI Trading Dashboard ç¶œåˆæ¸¬è©¦è…³æœ¬
echo "ğŸš€ AI Trading Dashboard ç¶œåˆæ¸¬è©¦é–‹å§‹..."
echo "========================================"

# å»ºç«‹æ¸¬è©¦çµæœç›®éŒ„
mkdir -p test-results
mkdir -p screenshots

# é¡è‰²å®šç¾©
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${YELLOW}æ­¥é©Ÿ 1: æª¢æŸ¥æœå‹™ç‹€æ…‹${NC}"
echo "----------------------------------------"

# æª¢æŸ¥ Next.js æœå‹™
echo "æª¢æŸ¥ Next.js æœå‹™ (localhost:3000)..."
if curl -f http://localhost:3000 > /dev/null 2>&1; then
    echo -e "${GREEN}âœ“ Next.js æœå‹™é‹è¡Œæ­£å¸¸${NC}"
else
    echo -e "${RED}âœ— Next.js æœå‹™æœªé‹è¡Œï¼Œè«‹å…ˆå•Ÿå‹•: npm run dev${NC}"
    exit 1
fi

# æª¢æŸ¥å¾Œç«¯ API æœå‹™
echo "æª¢æŸ¥å¾Œç«¯ API æœå‹™ (localhost:8000)..."
if curl -f http://localhost:8000/health > /dev/null 2>&1; then
    echo -e "${GREEN}âœ“ API æœå‹™é‹è¡Œæ­£å¸¸${NC}"
else
    echo -e "${YELLOW}âš  API æœå‹™æœªé‹è¡Œï¼ŒæŸäº›æ¸¬è©¦å¯èƒ½å¤±æ•—${NC}"
fi

echo -e "\n${YELLOW}æ­¥é©Ÿ 2: å®‰è£æ¸¬è©¦ä¾è³´${NC}"
echo "----------------------------------------"
if [ ! -d "node_modules/@playwright" ]; then
    echo "å®‰è£ Playwright..."
    npm install @playwright/test
    npx playwright install
else
    echo -e "${GREEN}âœ“ Playwright å·²å®‰è£${NC}"
fi

echo -e "\n${YELLOW}æ­¥é©Ÿ 3: åŸ·è¡Œç¶œåˆæ¸¬è©¦${NC}"
echo "----------------------------------------"

# åŸ·è¡Œæ¸¬è©¦
echo "é–‹å§‹åŸ·è¡Œ Playwright æ¸¬è©¦..."
npx playwright test --reporter=html,line

TEST_EXIT_CODE=$?

echo -e "\n${YELLOW}æ­¥é©Ÿ 4: ç”Ÿæˆæ¸¬è©¦å ±å‘Š${NC}"
echo "----------------------------------------"

if [ $TEST_EXIT_CODE -eq 0 ]; then
    echo -e "${GREEN}âœ… æ‰€æœ‰æ¸¬è©¦é€šéï¼${NC}"
else
    echo -e "${RED}âŒ éƒ¨åˆ†æ¸¬è©¦å¤±æ•—ï¼Œè«‹æŸ¥çœ‹è©³ç´°å ±å‘Š${NC}"
fi

# å‰µå»ºæ¸¬è©¦æ‘˜è¦
cat > test-results/test-summary.md << EOF
# AI Trading Dashboard æ¸¬è©¦å ±å‘Š

## æ¸¬è©¦åŸ·è¡Œæ™‚é–“
**åŸ·è¡Œæ—¥æœŸ:** $(date)
**æ¸¬è©¦ç‹€æ…‹:** $([ $TEST_EXIT_CODE -eq 0 ] && echo "âœ… é€šé" || echo "âŒ å¤±æ•—")

## æ¸¬è©¦é …ç›®è¦†è“‹

### 1. é é¢åŸºæœ¬è¼‰å…¥å’ŒéŸ¿æ‡‰ âœ“
- é é¢æ¨™é¡Œé©—è­‰
- ä¸»è¦å…ƒç´ è¼‰å…¥æª¢æŸ¥
- ç‹€æ…‹æŒ‡ç¤ºå™¨é©—è­‰

### 2. è‚¡ç¥¨æœå°‹åŠŸèƒ½ âœ“
- AAPL æœå°‹æ¸¬è©¦
- TSLA æœå°‹æ¸¬è©¦  
- 2330.TW æœå°‹æ¸¬è©¦
- è¼‰å…¥ç‹€æ…‹é©—è­‰

### 3. æµè¡Œè‚¡ç¥¨æŒ‰éˆ•åŠŸèƒ½ âœ“
- æŒ‰éˆ•é»æ“ŠéŸ¿æ‡‰
- ç‹€æ…‹è®Šæ›´é©—è­‰
- åœ–è¡¨æ›´æ–°æª¢æŸ¥

### 4. åœ–è¡¨è¼‰å…¥ç‹€æ…‹ âœ“
- è¼‰å…¥æŒ‡ç¤ºå™¨æª¢æŸ¥
- TradingView æ•´åˆé©—è­‰
- åœ–è¡¨å·¥å…·åˆ—æ¸¬è©¦

### 5. AIåˆ†æé¢æ¿ âœ“
- AI åˆ†æè§¸ç™¼
- è¼‰å…¥ç‹€æ…‹æª¢æŸ¥
- çµæœé¡¯ç¤ºé©—è­‰

### 6. å¸‚å ´æ•¸æ“šé¡¯ç¤º âœ“
- å¯¦æ™‚æ•¸æ“šé¡¯ç¤º
- æ•¸æ“šé …ç›®é©—è­‰
- ç‹€æ…‹æ›´æ–°æª¢æŸ¥

### 7. æŠ€è¡“åˆ†æåŠŸèƒ½å¡ç‰‡ âœ“
- åŠŸèƒ½å¡ç‰‡é¡¯ç¤º
- ç‹€æ…‹æŒ‡ç¤ºå™¨
- äº’å‹•æ•ˆæœæ¸¬è©¦

### 8. ç³»çµ±ç‹€æ…‹æŒ‡ç¤ºå™¨ âœ“
- API é€£æ¥ç‹€æ…‹
- å¯¦æ™‚æ•¸æ“šç‹€æ…‹
- ç³»çµ±æ™‚é–“é¡¯ç¤º

### 9. éŸ¿æ‡‰å¼è¨­è¨ˆæ¸¬è©¦ âœ“
- æ¡Œé¢è¦–çª— (1920x1080)
- å¹³æ¿è¦–çª— (768x1024)  
- æ‰‹æ©Ÿè¦–çª— (375x667)

### 10. éŒ¯èª¤æª¢æ¸¬å’ŒAPIé€£æ¥ âœ“
- JavaScript éŒ¯èª¤ç›£æ§
- API é€£æ¥æ¸¬è©¦
- éŒ¯èª¤è™•ç†é©—è­‰

### 11. æ€§èƒ½æ¸¬è©¦ âœ“
- é é¢è¼‰å…¥æ™‚é–“æ¸¬é‡
- æœå°‹éŸ¿æ‡‰æ™‚é–“æ¸¬é‡
- ç¶²çµ¡è«‹æ±‚åˆ†æ

## æˆªåœ–æ–‡ä»¶
æ¸¬è©¦éç¨‹ä¸­è‡ªå‹•ç”Ÿæˆçš„æˆªåœ–ä¿å­˜åœ¨ \`test-results/\` ç›®éŒ„ä¸­ï¼š

$(ls -la test-results/*.png 2>/dev/null | awk '{print "- " $9}' || echo "- ç„¡æˆªåœ–æ–‡ä»¶ç”Ÿæˆ")

## å»ºè­°æ”¹é€²é …ç›®
1. åŠ å¼·éŒ¯èª¤è™•ç†æ©Ÿåˆ¶
2. å„ªåŒ–è¼‰å…¥æ€§èƒ½
3. å¢åŠ æ›´å¤šç”¨æˆ¶äº’å‹•å›é¥‹
4. æ”¹å–„ç§»å‹•ç«¯é«”é©—

---
*æœ¬å ±å‘Šç”±è‡ªå‹•åŒ–æ¸¬è©¦å·¥å…·ç”Ÿæˆ*
EOF

echo -e "\n${YELLOW}æ­¥é©Ÿ 5: é–‹å•Ÿæ¸¬è©¦å ±å‘Š${NC}"
echo "----------------------------------------"
echo "æ¸¬è©¦å ±å‘Šå·²ç”Ÿæˆï¼š"
echo "- HTML å ±å‘Š: playwright-report/index.html"
echo "- æ¸¬è©¦æ‘˜è¦: test-results/test-summary.md"
echo "- æˆªåœ–æ–‡ä»¶: test-results/*.png"

# å˜—è©¦æ‰“é–‹ HTML å ±å‘Š
if command -v open &> /dev/null; then
    echo "æ­£åœ¨æ‰“é–‹æ¸¬è©¦å ±å‘Š..."
    open playwright-report/index.html
elif command -v xdg-open &> /dev/null; then
    xdg-open playwright-report/index.html
else
    echo "è«‹æ‰‹å‹•æ‰“é–‹ playwright-report/index.html æŸ¥çœ‹è©³ç´°å ±å‘Š"
fi

echo -e "\n${GREEN}æ¸¬è©¦åŸ·è¡Œå®Œæˆï¼${NC}"
echo "========================================"

exit $TEST_EXIT_CODE